import { useState, useEffect, useCallback } from "react";
import { Bug, Zap, Radar, Loader2, ChevronDown, ChevronRight } from "lucide-react";
import { toolsApi } from "../api/client";
import useWebSocket from "../hooks/useWebSocket";
import { PageHeader, FormField, TextInput, SelectInput, CheckboxInput } from "../components/ToolForm";
import OutputPanel from "../components/OutputPanel";
import StatusBadge from "../components/StatusBadge";

export default function Exploit({ setOutput, setTitle }) {
  const [query, setQuery] = useState("");
  const [exact, setExact] = useState(false);
  const [www, setWww] = useState(false);
  const [jsonOutput, setJsonOutput] = useState(false);
  const [extraFlags, setExtraFlags] = useState("");
  const [mirror, setMirror] = useState(false);
  const [showPath, setShowPath] = useState(false);
  const [exclude, setExclude] = useState("");
  const [cve, setCve] = useState("");
  const [taskId, setTaskId] = useState(null);
  const [status, setStatus] = useState(null);
  const [command, setCommand] = useState("");
  const [history, setHistory] = useState([]);

  const [nmapTasks, setNmapTasks] = useState([]);
  const [autoResults, setAutoResults] = useState(null);
  const [autoLoading, setAutoLoading] = useState(false);
  const [expandedService, setExpandedService] = useState(null);
  const [serviceOutputs, setServiceOutputs] = useState({});

  const ws = useWebSocket();

  useEffect(() => { setTitle("Exploit Search"); }, [setTitle]);
  useEffect(() => { if (ws.output) setOutput(ws.output); }, [ws.output, setOutput]);

  const loadHistory = useCallback(() => {
    toolsApi.history("searchsploit").then((res) => setHistory(res.data)).catch(() => {});
  }, []);
  useEffect(() => { loadHistory(); }, [loadHistory]);

  useEffect(() => {
    toolsApi.history("nmap").then((res) => {
      setNmapTasks(res.data.filter((t) => t.status === "completed").slice(0, 10));
    }).catch(() => {});
  }, []);

  useEffect(() => {
    if (!taskId) return;
    const interval = setInterval(async () => {
      try {
        const res = await toolsApi.status(taskId);
        setStatus(res.data.status);
        if (["completed", "error", "killed"].includes(res.data.status)) { clearInterval(interval); loadHistory(); }
      } catch {}
    }, 2000);
    return () => clearInterval(interval);
  }, [taskId, loadHistory]);

  const handleRun = async () => {
    if (!query.trim()) return;
    ws.reset(); setOutput("");
    const params = { query: query.trim(), exact, www, json: jsonOutput, extra_flags: extraFlags, mirror, path: showPath, exclude, cve };
    try {
      const res = await toolsApi.run("searchsploit", params);
      setTaskId(res.data.task_id); setCommand(res.data.command);
      setStatus("running"); ws.connect(res.data.task_id);
    } catch (err) { setOutput(`Error: ${err.message}\n`); }
  };

  const handleStop = async () => {
    if (taskId) { await toolsApi.kill(taskId); setStatus("killed"); }
  };

  const handleAutoExploit = async (nmapTaskId) => {
    setAutoLoading(true); setAutoResults(null);
    try {
      const res = await toolsApi.autoExploit({ task_id: nmapTaskId });
      setAutoResults(res.data);
      if (res.data.exploit_searches) {
        for (const es of res.data.exploit_searches) {
          pollServiceOutput(es.task_id);
        }
      }
    } catch (err) { setAutoResults({ error: err.message }); }
    setAutoLoading(false);
  };

  const pollServiceOutput = (tid) => {
    const interval = setInterval(async () => {
      try {
        const res = await toolsApi.status(tid);
        setServiceOutputs((prev) => ({ ...prev, [tid]: res.data }));
        if (["completed", "error", "killed"].includes(res.data.status)) {
          clearInterval(interval);
          loadHistory();
        }
      } catch {}
    }, 2000);
  };

  return (
    <div>
      <PageHeader title="Exploit Search" description="Search for exploits using SearchSploit and auto-chain from Nmap scans" icon={Bug} />
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div className="space-y-4">
          <div className="bg-sawlah-card border border-sawlah-border rounded-xl p-5 space-y-4">
            <FormField label="Search Query" hint="Service name, version, CVE, platform, etc.">
              <TextInput value={query} onChange={setQuery} placeholder="Apache 2.4.49, vsftpd 2.3.4, ms17-010, EternalBlue" />
            </FormField>
            <div className="flex flex-wrap gap-4">
              <CheckboxInput checked={exact} onChange={setExact} label="Exact match (--exact)" />
              <CheckboxInput checked={www} onChange={setWww} label="Show URLs (--www)" />
              <CheckboxInput checked={jsonOutput} onChange={setJsonOutput} label="JSON output (--json)" />
            </div>
            <FormField label="CVE Search" hint="Search by CVE ID"><TextInput value={cve} onChange={setCve} placeholder="2021-44228" /></FormField>
            <FormField label="Exclude Terms" hint="Exclude from results"><TextInput value={exclude} onChange={setExclude} placeholder="(PoC)|/dos/" /></FormField>
            <div className="flex flex-wrap gap-4">
              <CheckboxInput checked={mirror} onChange={setMirror} label="--mirror (download exploit)" />
              <CheckboxInput checked={showPath} onChange={setShowPath} label="--path (show full path)" />
            </div>
            <FormField label="Extra Flags"><TextInput value={extraFlags} onChange={setExtraFlags} placeholder="--colour --id" /></FormField>
          </div>

          {/* Auto-exploit from Nmap */}
          <div className="bg-sawlah-card border border-sawlah-border rounded-xl p-5">
            <div className="flex items-center gap-2 mb-3">
              <Zap className="w-4 h-4 text-sawlah-yellow" />
              <h3 className="text-xs font-semibold uppercase tracking-wider text-sawlah-muted">
                Auto-Exploit from Nmap
              </h3>
            </div>
            <p className="text-[11px] text-sawlah-dim mb-3">
              Pick a completed Nmap scan. Service versions will be extracted and searched automatically in SearchSploit.
            </p>

            {nmapTasks.length === 0 ? (
              <p className="text-xs text-sawlah-dim/60 text-center py-4">No completed Nmap scans found. Run an Nmap scan first.</p>
            ) : (
              <div className="space-y-1.5 max-h-[200px] overflow-y-auto">
                {nmapTasks.map((t) => (
                  <button key={t.id} onClick={() => handleAutoExploit(t.id)} disabled={autoLoading}
                    className="w-full flex items-center gap-2 px-3 py-2 bg-black/20 border border-sawlah-border rounded-lg hover:border-sawlah-yellow/30 transition-colors text-left disabled:opacity-50">
                    <Radar className="w-3.5 h-3.5 text-sawlah-red shrink-0" />
                    <div className="flex-1 min-w-0">
                      <p className="text-[10px] font-mono text-sawlah-dim truncate">{t.command}</p>
                    </div>
                    {autoLoading ? <Loader2 className="w-3.5 h-3.5 text-sawlah-yellow animate-spin" /> : <Zap className="w-3.5 h-3.5 text-sawlah-yellow" />}
                  </button>
                ))}
              </div>
            )}

            {autoResults && !autoResults.error && (
              <div className="mt-4 space-y-2">
                <div className="flex items-center gap-2 px-2 py-1 rounded bg-green-500/10 border border-green-500/20">
                  <span className="text-[10px] font-bold text-sawlah-green uppercase tracking-wider">
                    {autoResults.services?.length} services found - {autoResults.exploit_searches?.length} exploit searches launched
                  </span>
                </div>

                {autoResults.exploit_searches?.map((es, i) => {
                  const svcOut = serviceOutputs[es.task_id];
                  const isOpen = expandedService === i;
                  return (
                    <div key={i} className="border border-sawlah-border rounded-lg overflow-hidden">
                      <button onClick={() => setExpandedService(isOpen ? null : i)}
                        className="w-full flex items-center gap-2 px-3 py-2 hover:bg-white/[0.02] text-left text-xs">
                        {isOpen ? <ChevronDown className="w-3 h-3 text-sawlah-dim" /> : <ChevronRight className="w-3 h-3 text-sawlah-dim" />}
                        <span className="font-mono text-sawlah-red">{es.service.port}/{es.service.proto}</span>
                        <span className="text-sawlah-muted flex-1">{es.service.service}</span>
                        <span className="text-sawlah-dim font-mono text-[10px] truncate max-w-[150px]">{es.service.version}</span>
                        <StatusBadge status={svcOut?.status || es.status} />
                      </button>
                      {isOpen && svcOut && (
                        <div className="px-3 pb-2 border-t border-sawlah-border/50">
                          <div className="font-mono text-[10px] leading-relaxed p-2 rounded bg-black/30 max-h-[200px] overflow-y-auto mt-2">
                            {(svcOut.output || "Searching...").split("\n").map((line, li) => (
                              <div key={li} className={`${
                                /Exploit/i.test(line) ? "text-sawlah-red" :
                                /Shellcode/i.test(line) ? "text-sawlah-yellow" :
                                "text-zinc-400"
                              }`}>{line || "\u00A0"}</div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            )}
            {autoResults?.error && <p className="text-xs text-sawlah-red mt-3">{autoResults.error}</p>}
          </div>
        </div>

        <OutputPanel onRun={handleRun} onStop={handleStop} status={status} command={command} output={ws.output} history={history} toolName="searchsploit" />
      </div>
    </div>
  );
}
