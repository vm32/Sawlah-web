import { useState, useEffect, useCallback } from "react";
import { Bug } from "lucide-react";
import { toolsApi } from "../api/client";
import useWebSocket from "../hooks/useWebSocket";
import { PageHeader, FormField, TextInput, CheckboxInput } from "../components/ToolForm";
import OutputPanel from "../components/OutputPanel";

export default function Exploit({ setOutput, setTitle }) {
  const [query, setQuery] = useState("");
  const [exact, setExact] = useState(false);
  const [www, setWww] = useState(false);
  const [extraFlags, setExtraFlags] = useState("");
  const [taskId, setTaskId] = useState(null);
  const [status, setStatus] = useState(null);
  const [command, setCommand] = useState("");
  const [history, setHistory] = useState([]);

  const ws = useWebSocket();

  useEffect(() => { setTitle("Exploit Search"); }, [setTitle]);
  useEffect(() => { if (ws.output) setOutput(ws.output); }, [ws.output, setOutput]);

  const loadHistory = useCallback(() => {
    toolsApi.history("searchsploit").then((res) => setHistory(res.data)).catch(() => {});
  }, []);
  useEffect(() => { loadHistory(); }, [loadHistory]);

  useEffect(() => {
    if (!taskId) return;
    const interval = setInterval(async () => {
      try {
        const res = await toolsApi.status(taskId);
        setStatus(res.data.status);
        if (["completed", "error", "killed"].includes(res.data.status)) { clearInterval(interval); loadHistory(); }
      } catch {}
    }, 2000);
    return () => clearInterval(interval);
  }, [taskId, loadHistory]);

  const handleRun = async () => {
    if (!query.trim()) return;
    ws.reset(); setOutput("");
    const params = { query: query.trim(), exact, www, extra_flags: extraFlags };
    try {
      const res = await toolsApi.run("searchsploit", params);
      setTaskId(res.data.task_id); setCommand(res.data.command);
      setStatus("running"); ws.connect(res.data.task_id);
    } catch (err) { setOutput(`Error: ${err.message}\n`); }
  };

  const handleStop = async () => {
    if (taskId) { await toolsApi.kill(taskId); setStatus("killed"); }
  };

  return (
    <div>
      <PageHeader title="Exploit Search" description="Search for exploits using SearchSploit (Exploit-DB)" icon={Bug} />
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
        <div className="bg-sawlah-card border border-sawlah-border rounded-xl p-5 space-y-4">
          <FormField label="Search Query" hint="Service name, version, CVE, etc.">
            <TextInput value={query} onChange={setQuery} placeholder="Apache 2.4.49, vsftpd 2.3.4, ms17-010" />
          </FormField>
          <div className="flex gap-4">
            <CheckboxInput checked={exact} onChange={setExact} label="Exact match (--exact)" />
            <CheckboxInput checked={www} onChange={setWww} label="Show URLs (--www)" />
          </div>
          <FormField label="Extra Flags"><TextInput value={extraFlags} onChange={setExtraFlags} placeholder="Additional flags" /></FormField>
        </div>

        <OutputPanel onRun={handleRun} onStop={handleStop} status={status} command={command} output={ws.output} history={history} />
      </div>
    </div>
  );
}
